---
title: "PHOIBLE data dump to CLDF 1.0"
author: "Steven Moran \\<steven.moran@uzh.ch\\>"
output: github_document
---
  
```{r, message=F, warning=F}
library(stringi)
library(Unicode)
library(tidyverse)
library(testthat)
library(digest)
```

```{r}
# PHOIBLE aggregated data
## TODO: update once the aggregation script is finished (and tag the version)
load(url('https://raw.githubusercontent.com/phoible/dev/refactor-agg/data/phoible-by-phoneme.RData'))
phoible$InventoryID <- as.integer(phoible$InventoryID)
expect_equal(nrow(phoible), 95993)
```

```{r}
# TODO: Problems to address! Submited to phoible/dev issues / aggregation PR.
# 1. spaces in LanguageName
# 2. PHOIBLE ISO != Glottolog ISO 

# Groups:   InventoryID, LanguageName, Glottocode, LanguageCode [3]
# InventoryID LanguageName Glottocode LanguageCode name  macroarea latitude longitude isocodes
# <int> <chr>        <chr>      <chr>        <fct> <fct>        <dbl>     <dbl> <fct>   
# 1         298 DAN          dann1241   lda          Dan   Africa        7.23     -8.25 daf     
# 2         691 "dan "       dann1241   dnj          Dan   Africa        7.23     -8.25 daf     
# 3        1393 Dan          dann1241   lda          Dan   Africa        7.23     -8.25 daf  

phoible %>% filter(InventoryID %in% c(691,298,1393)) %>% distinct(InventoryID, LanguageCode, LanguageName)
```

# Create one large table

```{r}
# Contributors data
contributors <- read.csv("contributors.csv")
phoible <- left_join(phoible, contributors, by=c("Source"="ID"))

# Get bibtex keys in semi-colon delimited list
refs <- read.table('https://raw.githubusercontent.com/phoible/dev/master/mappings/InventoryID-Bibtex.tsv', sep="\t", header=T, stringsAsFactors=F)
citations <- refs %>% group_by(InventoryID) %>% summarize(Contribution_ID=tolower(paste(BibtexKey, collapse=";")))
phoible <- left_join(phoible, citations)
rm(refs, citations)

# Generate parameter ID (much quicker if we get a unique list of the phonemes first)
parameters <- phoible %>% select(Phoneme) %>% distinct(Phoneme) %>% arrange(Phoneme)
names <- sapply(parameters$Phoneme, function(x) u_char_name(as.u_char(utf8ToInt(x))))
parameters <- mutate(parameters, Phoneme_description = stri_join_list(names, sep = " - "))

# Get the segment name IDs
library(digest)
parameters$Parameter_ID <- sapply(parameters$Phoneme_description, digest, algo="md5")

# Merge in the phoneme parameters
phoible <- left_join(phoible, parameters)
rm(names, parameters)

# But how to get the b16 encoding?
# https://github.com/clld/phoible/blob/73d140ae4c3377140fe3678b1997d0c13d42ad41/phoible/scripts/initializedb.py#L353-L357
# library(caTools)
# base64encode(x)
# library(hashids)
# hashids::encode_hex(x)

# Add in row "ID"s
phoible$ROWID <- seq.int(nrow(phoible))
```

# Dump the individual tables for CLDF

## values.csv
```{r}
# values.csv
## ID,Language_ID,Parameter_ID,Value,Code_ID,Comment,Source,Contribution_ID
## 1,kor,9C6117430968F42700ACD02E4E7442F7,t̠ʃʰ Korean (SPA),,,cho1967;kim1972;martin1954;martinlee1969;martin1951;kim1968,1
## 14564,kor,9C6117430968F42700ACD02E4E7442F7,t̠ʃʰ Korean (UPSID),,,kim1986;martin1951;martinlee1969;martin1954;cho1967;kim1972,423

# "ID","Language_ID","Parameter_ID","Value","Code_ID","Comment","Source","Contribution_ID"
values <- phoible %>% select(ROWID, LanguageCode, Glottocode, Parameter_ID, Phoneme, Allophones, Source, InventoryID)
colnames(values) <- c("ID", "ISO639P3code", "Language_ID", "Parameter_ID", "Name", "Allophones", "Source", "Contribution_ID")
expect_equal(nrow(phoible), nrow(values))
glimpse(values)
write.csv(values, file="cldf/values.csv", row.names=FALSE)
rm(values)
```

## parameters.csv

```{r}
# parameters.csv
## ID,Name,Description
## 9C6117430968F42700ACD02E4E7442F7,t̠ʃʰ,LATIN SMALL LETTER T - COMBINING MINUS SIGN BELOW - LATIN SMALL LETTER ESH - MODIFIER LETTER SMALL H
## 41D8827BB943E1FB9055A7487293BA79,pˀ,LATIN SMALL LETTER P - MODIFIER LETTER GLOTTAL STOP
parameters <- phoible %>% select(Parameter_ID, Phoneme, Phoneme_description) %>% distinct()
colnames(parameters) <- c("ID", "Name", "Description")
glimpse(parameters)
write.csv(parameters, file="cldf/parameters.csv", row.names=FALSE)
rm(parameters)
```

## contributions.csv

```{r}
# contributions.csv:
## ID,Name,Description,Contributors
## 1,Korean (SPA),Korean,Stanford Phonology Archive

contributions <- phoible %>% select(InventoryID, Source, LanguageName, Contributor, Contribution_ID) %>% distinct()
colnames(contributions) <- c("ID", "Contributor_ID", "Name", "Contributors", "References")
glimpse(contributions)
write.csv(contributions, file="cldf/contributions.csv", row.names=FALSE)
rm(contributions)
```

## contributors.csv
```{r}
write.csv(contributors, file="cldf/contributors.csv", row.names=FALSE)
glimpse(contributors)
rm(contributors)
rm(phoible)
```


